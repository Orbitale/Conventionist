{% extends 'base.html.twig' %}

{% block title %}{{ floor.name }} - Venue Map{% endblock %}

{% block body %}
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>
                        <i class="fas fa-map-marked-alt"></i>
                        {{ floor.name }}
                        <small class="text-muted">Venue Map</small>
                    </h1>
                    <div>
                        <button id="zoom-in" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button id="zoom-out" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button id="reset-zoom" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-expand-arrows-alt"></i> Reset
                        </button>
                    </div>
                </div>

                {% if floor.hasMap %}
                    <div class="card">
                        <div class="card-body p-0">
                            <div id="map-container" class="position-relative overflow-auto" style="height: 80vh; background: #f8f9fa;">
                                <div id="map-canvas" class="position-relative" style="transform-origin: top left;">
                                    <img id="floor-plan" 
                                         src="{{ floor.mapImageData }}"
                                         alt="Floor Plan - {{ floor.name }}" 
                                         style="width: {{ floor.mapWidth }}px; height: {{ floor.mapHeight }}px; display: block;">
                                    
                                    <!-- Rooms and booths will be rendered here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Map Legend</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="legend-box" style="background-color: #e3f2fd; border: 2px solid #333;"></div>
                                        <span class="ms-2">Rooms</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="legend-box" style="background-color: #fff3e0; border: 2px solid #333;"></div>
                                        <span class="ms-2">Booths</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-mouse-pointer"></i> Instructions</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0 small">
                                        <li>Click on any room or booth to see details</li>
                                        <li>Use zoom controls to get a closer look</li>
                                        <li>Scroll or drag to navigate around the map</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        <h5><i class="fas fa-map"></i> Map Not Available</h5>
                        <p class="mb-0">The venue map for this floor is not yet configured.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Element Details Modal -->
    <div class="modal fade" id="elementDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="element-modal-title">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="element-modal-body">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .legend-box {
            width: 20px;
            height: 15px;
            display: inline-block;
        }
        
        .map-element {
            transition: all 0.2s ease;
        }
        
        .map-element:hover {
            transform: scale(1.05);
            z-index: 1000 !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .map-room {
            opacity: 0.8;
        }
        
        .map-booth {
            opacity: 0.9;
        }
        
        #map-container {
            cursor: grab;
        }
        
        #map-container:active {
            cursor: grabbing;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        const PublicVenueMap = {
            mapData: {{ mapData|json_encode|raw }},
            zoomLevel: 1,
            maxZoom: 3,
            minZoom: 0.5,
            
            init() {
                this.bindEvents();
                {% if floor.hasMap %}
                    this.renderMap();
                    this.setupPanAndZoom();
                {% endif %}
            },
            
            bindEvents() {
                document.getElementById('zoom-in')?.addEventListener('click', () => {
                    this.zoom(1.2);
                });
                
                document.getElementById('zoom-out')?.addEventListener('click', () => {
                    this.zoom(0.8);
                });
                
                document.getElementById('reset-zoom')?.addEventListener('click', () => {
                    this.resetZoom();
                });
            },
            
            renderMap() {
                const canvas = document.getElementById('map-canvas');
                if (!canvas || !this.mapData.rooms) return;
                
                // Clear existing elements
                canvas.querySelectorAll('.map-element').forEach(el => el.remove());
                
                // Render rooms
                this.mapData.rooms.forEach(room => {
                    if (room.x !== null && room.y !== null) {
                        this.renderRoom(room);
                        
                        // Render booths within room
                        if (room.booths) {
                            room.booths.forEach(booth => {
                                if (booth.x !== null && booth.y !== null) {
                                    this.renderBooth(booth);
                                }
                            });
                        }
                    }
                });
            },
            
            renderRoom(room) {
                const element = this.createElement('room', room);
                document.getElementById('map-canvas').appendChild(element);
            },
            
            renderBooth(booth) {
                const element = this.createElement('booth', booth);
                document.getElementById('map-canvas').appendChild(element);
            },
            
            createElement(type, data) {
                const element = document.createElement('div');
                element.className = `map-element map-${type}`;
                element.dataset.type = type;
                element.dataset.id = data.id;
                element.style.cssText = `
                    position: absolute;
                    left: ${data.x}px;
                    top: ${data.y}px;
                    width: ${data.width}px;
                    height: ${data.height}px;
                    background-color: ${data.color};
                    border: 2px solid #333;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: bold;
                    color: #333;
                    z-index: ${type === 'booth' ? 10 : 5};
                `;
                element.textContent = data.name;
                
                element.addEventListener('click', () => {
                    this.showElementDetails(type, data);
                });
                
                return element;
            },
            
            showElementDetails(type, data) {
                const modal = new bootstrap.Modal(document.getElementById('elementDetailsModal'));
                const title = document.getElementById('element-modal-title');
                const body = document.getElementById('element-modal-body');
                
                title.textContent = `${type === 'room' ? 'Room' : 'Booth'}: ${data.name}`;
                
                let content = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Type:</strong><br>
                            <span class="badge bg-${type === 'room' ? 'primary' : 'secondary'}">${type === 'room' ? 'Room' : 'Booth'}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Dimensions:</strong><br>
                            ${data.width} Ã— ${data.height} pixels
                        </div>
                    </div>
                `;
                
                if (type === 'booth' && data.maxParticipants) {
                    content += `
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <strong>Maximum Participants:</strong><br>
                                ${data.maxParticipants} people
                            </div>
                        </div>
                    `;
                }
                
                if (type === 'booth' && data.allowRegistration !== undefined) {
                    content += `
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <strong>Registration:</strong><br>
                                <span class="badge bg-${data.allowRegistration ? 'success' : 'danger'}">
                                    ${data.allowRegistration ? 'Open' : 'Closed'}
                                </span>
                            </div>
                        </div>
                    `;
                }
                
                body.innerHTML = content;
                modal.show();
            },
            
            setupPanAndZoom() {
                const container = document.getElementById('map-container');
                const canvas = document.getElementById('map-canvas');
                let isPanning = false;
                let startX, startY, initialScrollLeft, initialScrollTop;

                console.info('setup pan and zoom');
                console.info('container', container);
                
                // Pan functionality
                container.addEventListener('mousedown', (e) => {
                    isPanning = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialScrollLeft = container.scrollLeft;
                    initialScrollTop = container.scrollTop;
                    container.style.cursor = 'grabbing';
                });
                
                container.addEventListener('mousemove', (e) => {
                    if (!isPanning) return;
                    e.preventDefault();
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    container.scrollLeft = initialScrollLeft - deltaX;
                    container.scrollTop = initialScrollTop - deltaY;
                });
                
                container.addEventListener('mouseup', () => {
                    isPanning = false;
                    container.style.cursor = 'grab';
                });
                
                container.addEventListener('mouseleave', () => {
                    isPanning = false;
                    container.style.cursor = 'grab';
                });
                
                // Zoom with mouse wheel
                container.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                    this.zoom(zoomFactor);
                });
            },
            
            zoom(factor) {
                this.zoomLevel *= factor;
                this.zoomLevel = Math.max(this.minZoom, Math.min(this.maxZoom, this.zoomLevel));
                
                const canvas = document.getElementById('map-canvas');
                canvas.style.transform = `scale(${this.zoomLevel})`;
                
                // Update container size to accommodate scaled content
                const container = document.getElementById('map-container');
                const img = document.getElementById('floor-plan');
                if (img) {
                    const scaledWidth = img.offsetWidth * this.zoomLevel;
                    const scaledHeight = img.offsetHeight * this.zoomLevel;
                    canvas.style.width = scaledWidth + 'px';
                    canvas.style.height = scaledHeight + 'px';
                }
            },
            
            resetZoom() {
                this.zoomLevel = 1;
                const canvas = document.getElementById('map-canvas');
                canvas.style.transform = 'scale(1)';
                canvas.style.width = '';
                canvas.style.height = '';
                
                const container = document.getElementById('map-container');
                container.scrollLeft = 0;
                container.scrollTop = 0;
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            PublicVenueMap.init();
        });
    </script>
{% endblock %}